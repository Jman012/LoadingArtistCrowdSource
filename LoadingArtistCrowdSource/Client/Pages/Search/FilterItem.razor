<div class="dropdown">
	<button type="button" id="@($"{Field.Code}-btn-label")" class="@($"btn {(FilterData.FieldValues.Any(fv => fv.Filtered) ? "btn-secondary" : "btn-light")} btn-sm dropdown-toggle")" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
		@dropdownText
	</button>
	<ul class="dropdown-menu checkbox-menu allow-focus" aria-labelledby="@($"{Field.Code}-btn-label")">

		@switch (Field.Type)
		{
			case CrowdSourcedFieldType.IntegerNumber:
			case CrowdSourcedFieldType.FreeformTextfield:
			case CrowdSourcedFieldType.FreeformTextarea:
				<li class="dropdown-item-text">
					<div class="input-group">
						<InputText class="form-control" @bind-Value="FilterData.FieldValues[0].Code"></InputText>
						<button type="button" class="btn btn-sm bg-transparent" style="margin-left: -28px; z-index: 100;" @onclick="ClearSearchInput">
							<i class="fa fa-times"></i>
						</button>
					</div>
				</li>
				break;
			default:
				<li class="dropdown-item-text">
					<div class="input-group">
						<input type="text" value="@_searchText" class="form-control form-control-sm" placeholder="Search..." @oninput="HandleSearchInput" />
						<button type="button" class="btn btn-sm bg-transparent" style="margin-left: -28px; z-index: 100;" @onclick="ClearSearchInput">
							<i class="fa fa-times"></i>
						</button>
					</div>
				</li>
				<li class="dropdown-divider"></li>
				<InputRadioGroup TValue="SearchEntryOperator" Value="@FilterData.Operator" ValueExpression="() => FilterData.Operator" ValueChanged="OperatorDidChange">
					@foreach (var op in System.Enum.GetValues(typeof(SearchEntryOperator)).Cast<SearchEntryOperator>())
					{
						<li>
							<label>
								<InputRadio Value="op"></InputRadio>
								@op.ToString()
							</label>
						</li>
					}
				</InputRadioGroup>
				<li class="dropdown-divider"></li>
				@foreach (var option in _searchedOptions)
				{
					<li>
						<label>
							<InputCheckbox Value="option.Item1.Filtered" ValueExpression="() => option.Item1.Filtered" ValueChanged="(filtered) => OptionDidChange(option.Item1, filtered)"></InputCheckbox>
							@option.Item2.Text
						</label>
					</li>
				}
				break;
		}
	</ul>
</div>

@code {

	[Parameter]
	public ComicFieldViewModel Field { get; set; } = new ComicFieldViewModel();
	[Parameter]
	public SearchEntryViewModel FilterData { get; set; } = new SearchEntryViewModel();
	[Parameter]
	public EventCallback<SearchEntryViewModel>? FilterDataChanged { get; set; }

	private List<CrowdSourcedFieldDefinitionOptionViewModel> _fieldOptions = new List<CrowdSourcedFieldDefinitionOptionViewModel>();

	private string? _searchText;
	private (SearchEntryOptionViewModel, CrowdSourcedFieldDefinitionOptionViewModel)[] _searchedOptions = new (SearchEntryOptionViewModel, CrowdSourcedFieldDefinitionOptionViewModel)[] { };

	private string dropdownText
	{
		get
		{
			if (FilterData.FieldValues.Zip(_fieldOptions).Any(o => o.First.Filtered))
			{
				string values = string.Join(FilterData.Operator.Separator(), FilterData.FieldValues.Zip(_fieldOptions).Where(o => o.First.Filtered).Select(o => o.Second.Text));
				return $"{Field.Name}: {values}";
			}
			else
			{
				return "Any " + Field.Name;
			}
		}
	}

	protected override async Task OnInitializedAsync()
	{
		FilterData.FieldCode = Field.Code;

		switch (Field.Type)
		{
			case CrowdSourcedFieldType.IntegerNumber:
			case CrowdSourcedFieldType.FreeformTextfield:
			case CrowdSourcedFieldType.FreeformTextarea:
				_fieldOptions = new List<CrowdSourcedFieldDefinitionOptionViewModel>();
				FilterData.FieldValues = new SearchEntryOptionViewModel[]
				{
					new SearchEntryOptionViewModel()
					{
						Code = "",
						Filtered = true,
					},
				};
				break;
			default:
				_fieldOptions = Field.Options;
				FilterData.FieldValues = _fieldOptions.Select(o => new SearchEntryOptionViewModel() { Code = o.Code, Filtered = false }).ToArray();
				break;
		}
		await DidChange();
		performSearch();
		base.OnInitialized();
	}

	private void HandleSearchInput(ChangeEventArgs e)
	{
		_searchText = e.Value as string;
		performSearch();
	}

	private void ClearSearchInput()
	{
		_searchText = "";
		performSearch();
	}

	private void performSearch()
	{
		if (string.IsNullOrEmpty(_searchText))
		{
			_searchedOptions = FilterData.FieldValues
				.Zip(_fieldOptions)
				.ToArray();
		}
		else
		{
			_searchedOptions = FilterData.FieldValues
				.Zip(_fieldOptions)
				.Where(o => o.Second.Text.Contains(_searchText, StringComparison.OrdinalIgnoreCase))
				.ToArray();
		}
	}

	private async Task OperatorDidChange(SearchEntryOperator op)
	{
		FilterData.Operator = op;
		await DidChange();
	}

	private async Task OptionDidChange(SearchEntryOptionViewModel searchEntryOption, bool filtered)
	{
		searchEntryOption.Filtered = filtered;
		await DidChange();
	}

	private async Task DidChange()
	{
		switch (Field.Type)
		{
			case CrowdSourcedFieldType.IntegerNumber:
			case CrowdSourcedFieldType.FreeformTextfield:
			case CrowdSourcedFieldType.FreeformTextarea:
				FilterData.FieldValues[0].Filtered = !string.IsNullOrEmpty(FilterData.FieldValues[0].Code);
				break;
			default:
				break;
		}
		if (FilterDataChanged != null)
		{
			await FilterDataChanged.Value.InvokeAsync(FilterData);
		}
	}
}
